'use client'
import { useEffect, useState } from 'react'
import { supabase } from '@/lib/supabaseClient'
export default function TasksPage(){
  const [rows,setRows]=useState([]); const [uid,setUid]=useState('')
  useEffect(()=>{ supabase.auth.getUser().then(async ({data})=>{ const id=data?.user?.id; setUid(id||''); if(!id) return; const { data:tasks } = await supabase.from('task_assignees').select('completed_at,complete_note,tasks:task_id(id,title,description,priority,due_type,due_at,status)').eq('user_id',id).order('assigned_at',{ascending:false}); setRows(tasks||[]) }) },[])
  async function markDone(task_id){ if(!uid) return; await supabase.from('task_assignees').update({completed_at:new Date().toISOString()}).eq('task_id',task_id).eq('user_id',uid); setRows(rows.map(r=> r.tasks.id===task_id ? {...r,completed_at:new Date().toISOString()} : r)); await fetch('/api/notify/task-complete',{method:'POST',headers:{'content-type':'application/json'},body:JSON.stringify({task_id})}) }
  return (<div className="space-y-4"><div className="card"><h1 className="text-xl font-bold">My Tasks</h1></div>{rows.length?rows.map(r=>(<div key={r.tasks.id} className="card space-y-1"><div className="flex items-center justify-between"><div className="font-semibold">{r.tasks.title}</div><span className="badge">{r.tasks.priority}</span></div><div className="text-sm text-gray-600">{r.tasks.description||''}</div><div className="text-xs text-gray-500">Due: {r.tasks.due_type} {r.tasks.due_at?'Â· '+new Date(r.tasks.due_at).toLocaleDateString():''}</div><div className="pt-2"><button className="btn btn-primary" disabled={!!r.completed_at} onClick={()=>markDone(r.tasks.id)}>{r.completed_at?'Completed':'Mark Done'}</button></div></div>)):<div className="card">No tasks assigned.</div>}</div>)}
