import * as XLSX from 'xlsx'
import { sbAdmin } from '@/lib/serverAdmin'
export function dateRangeFor(kind){ const now=new Date(); const u=d=>new Date(Date.UTC(d.getUTCFullYear(),d.getUTCMonth(),d.getUTCDate())); let start,end; if(kind==='weekly'){const s=new Date(now);s.setUTCDate(now.getUTCDate()-now.getUTCDay());const e=new Date(s);e.setUTCDate(s.getUTCDate()+6);start=u(s);end=u(e)} else if(kind==='biweekly'){const s=new Date(now);s.setUTCDate(now.getUTCDate()-now.getUTCDay());const p=new Date(s);p.setUTCDate(s.getUTCDate()-7);start=u(p);end=u(s);end.setUTCDate(end.getUTCDate()+6)} else {start=new Date(Date.UTC(now.getUTCFullYear(),now.getUTCMonth(),1)); end=new Date(Date.UTC(now.getUTCFullYear(),now.getUTCMonth()+1,0))} const iso=d=>d.toISOString().slice(0,10); return {start,end,startStr:iso(start),endStr:iso(end)} }
export async function fetchFinalPaidMinutes(startStr,endStr){ const sb=sbAdmin(); const { data, error } = await sb.rpc('report_sum_minutes_paid',{p_start:startStr,p_end:endStr}); if(error) throw error; return data||[] }
export function toCSV(rows){ const header=['Employee Name','Email','Employee Code','Minutes Paid','Final Paid Hours']; const lines=[header.join(',')]; for(const r of rows){ const hours=(r.minutes_paid||0)/60; lines.push([r.name||'',r.email||'',r.employee_code||'',r.minutes_paid||0,hours.toFixed(2)].join(',')) } return lines.join('\n') }
export function toXLSX(rows,meta){ const sheet=[['Employee Name','Email','Employee Code','Minutes Paid','Final Paid Hours']]; for(const r of rows){ sheet.push([r.name||'',r.email||'',r.employee_code||'',r.minutes_paid||0,((r.minutes_paid||0)/60).toFixed(2)]) } const wb=XLSX.utils.book_new(); const ws=XLSX.utils.aoa_to_sheet(sheet); XLSX.utils.book_append_sheet(wb,ws,'Report'); const buf=XLSX.write(wb,{type:'buffer',bookType:'xlsx'}); const fname=`${meta.kind}_${meta.startStr}_${meta.endStr}.xlsx`; return { buf, fname } }
